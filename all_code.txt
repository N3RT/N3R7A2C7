# SNAPSHOT OF PROJECT FILES (TEXT)
# Each file is separated by a marker line: ## FILE: <relative_path>

## FILE: DEV_LOG.txt
[2026-02-05 11:59] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä–∫–∞—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ rag_advct –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω–æ–π LLM —á–µ—Ä–µ–∑ ollama_chat_4b.

1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –°–æ–∑–¥–∞–Ω –±–∞–∑–æ–≤—ã–π –∫–∞—Ä–∫–∞—Å –∫–∞—Ç–∞–ª–æ–≥–∞ rag_advct –ø–æ –¢–ó RAG-—Å–∏—Å—Ç–µ–º—ã:
  - app/ (–∏—Å—Ö–æ–¥–Ω–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞)
  - app/api/, app/core/, app/ingestion/, app/postprocessing/, app/bot/, app/cli/
  - config/ (system.yaml + –∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è tasks/)
  - data/ (data/.gitkeep, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ chromadb/sqlite/logs)
  - docker/ (Dockerfile, docker-compose.dev.yml ‚Äì –ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ –∑–∞–≥–ª—É—à–∫–∏)
  - llm_connectors/ (–º–æ–¥—É–ª–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ LLM)
  - tests/ (test_api.py ‚Äì –∑–∞–≥–æ—Ç–æ–≤–∫–∞)
- –í .gitignore –¥–æ–±–∞–≤–ª–µ–Ω—ã:
  - .env
  - –∫–∞—Ç–∞–ª–æ–≥ data/ (–∫—Ä–æ–º–µ data/.gitkeep)
  - *.log, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ *.md.tmp, *.docx
  - all_code.py, DEV_LOG.txt, PROJECT_PLAN.txt
  —á—Ç–æ–±—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –±—ã–ª–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ª–æ–≥–æ–≤ –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤.

2. –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–Ω–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
- –í .venv —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
  - fastapi[standard]
  - uvicorn
  - requests
  - httpx
- –í—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑:
  - source .venv/bin/activate

3. –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª config/system.yaml —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
  - environment: dev
  - paths:
      data_root: ./data
      chromadb_dir: ./data/chromadb
      sqlite_path: ./data/sqlite/tables.db
      logs_path: ./data/logs/app.log
  - llm:
      mode: dev
      connector: "llm_connectors.connector_dev:call_llm"
- –≠—Ç–æ –∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥-–ª–æ–∞–¥–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ (dev/test/prod) —Å—Ç—Ä–æ–≥–æ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ –¢–ó.

4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω–æ–π LLM —á–µ—Ä–µ–∑ ollama_chat_4b
- –ü—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö API (DeepSeek/OpenRouter) –≤ dev –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –∏ –∑–∞–≤—è–∑–∫–∏ –Ω–∞ –±–∏–ª–ª–∏–Ω–≥.
- –í –∫–∞—á–µ—Å—Ç–≤–µ dev-LLM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫:
  - –¥–≤–∏–∂–æ–∫ Ollama —Å –º–æ–¥–µ–ª—è–º–∏ llama3.2:1b –∏ llama3.2:3b
  - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å ollama_chat_4b (FastAPI + uvicorn) —Å HTTP API:
    - POST http://127.0.0.1:4004/api/chat
    - —Ç–µ–ª–æ: {"messages": [...], "model": "llama3.2:1b"|"llama3.2:3b" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)}
    - –æ—Ç–≤–µ—Ç: {"reply": "...", "raw": {... –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç Ollama ...}}
- –í rag_advct —Å–æ–∑–¥–∞–Ω –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä llm_connectors/connector_dev.py:
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç httpx.AsyncClient —Å —Ç–∞–π–º–∞—É—Ç–æ–º 120 —Å–µ–∫—É–Ω–¥
  - —á–∏—Ç–∞–µ—Ç OLLAMA_CHAT_URL –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é http://127.0.0.1:4004/api/chat)
  - —Ñ—É–Ω–∫—Ü–∏—è async call_llm(messages, model=None):
    - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç messages –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI (role/content) –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
    - –ø—Ä–∏ model != None –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ "model" –≤ –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä "llama3.2:1b" –∏–ª–∏ "llama3.2:3b")
    - –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç {"reply": "...", "raw": {...}}
    - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å OpenAI:
      {
        "model": <–∏–º—è –º–æ–¥–µ–ª–∏ –∏–ª–∏ "default">,
        "choices": [
          {"message": {"role": "assistant", "content": reply}}
        ],
        "raw": <–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–∏—Å–∞>
      }
    - –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç LLMError —Å —Ç–µ–∫—Å—Ç–æ–º –≤–∏–¥–∞ "ollama_chat_4b error <code>: <body>"

5. –û—Å–Ω–æ–≤–Ω–æ–π FastAPI-—Å–µ—Ä–≤–∏—Å (app/main.py)
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI, –∫–æ—Ç–æ—Ä–æ–µ –≤ –±—É–¥—É—â–µ–º —Å—Ç–∞–Ω–µ—Ç REST-—Å–µ—Ä–≤–∏—Å–æ–º RAG:
  - title="RAG Service", version="0.1.0"
- –î–æ–±–∞–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç GET /api/v1/health:
  - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON:
    {
      "status": "ok",
      "environment": "dev",
      "chromadb": "unknown",
      "sqlite": "unknown",
      "llm_mode": "ollama_chat_4b",
      "uptime_seconds": 0
    }
  - –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π health-check –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î/ChromaDB.
- –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç GET /api/v1/llm_test:
  - –≤—ã–∑—ã–≤–∞–µ—Ç async call_llm –∏–∑ llm_connectors/connector_dev.py
  - –ø–µ—Ä–µ–¥–∞—ë—Ç –æ–¥–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞–∂–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: —Ç–µ—Å—Ç."
  - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë—Ç model="llama3.2:1b"
  - –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–∑ resp["choices"][0]["message"]["content"]
  - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON:
    - {"ok": True, "answer": "<–æ—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏>"} –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    - {"ok": False, "error": "<—Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏>"} –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ LLMError
- –≠–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/llm_test —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ curl:
  - –ø—Ä–∏ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö ollama –∏ ollama_chat_4b –≤–æ–∑–≤—Ä–∞—Ç:
    {"ok": true, "answer": "–¢–µ—Å—Ç - ..."} (–∂–∏–≤–æ–π –æ—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏),
    —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ä–∞–±–æ—á—É—é —Å–≤—è–∑–∫—É rag_advct ‚Üí ollama_chat_4b ‚Üí Ollama.

6. .env –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- –¢–µ–∫—É—â–∏–π .env —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
  - OLLAMA_CHAT_URL=http://127.0.0.1:4004/api/chat
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è rag_advct —Å–µ–π—á–∞—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã, –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã LLM –æ—Ç–∫–ª—é—á–µ–Ω—ã.

7. –ò—Ç–æ–≥–∏ —à–∞–≥–∞
- –ï—Å—Ç—å —Ä–∞–±–æ—á–∏–π –∫–∞—Ä–∫–∞—Å —Å–µ—Ä–≤–∏—Å–∞ rag_advct:
  - FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å health-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –∏ —Ç–µ—Å—Ç–æ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ LLM.
  - –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É LLM-—Å–µ—Ä–≤–∏—Å—É ollama_chat_4b.
  - –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –±–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è system.yaml –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ TaskConfig, RAG-–ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ —Ä–µ–∂–∏–º–æ–≤ prod/dev/test.
- –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ):
  - —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å config_loader –∏ –º–æ–¥–µ–ª—å TaskConfig –ø–æ –¢–ó,
  - –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/task/query, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –∑–∞–¥–∞—á–∏ –∏ –ª–æ–∫–∞–ª—å–Ω—É—é LLM —á–µ—Ä–µ–∑ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä.


[2026-02-05 13:02] –î–µ–º–æ-—ç–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/task/query –∏ –∫–æ–Ω—Ñ–∏–≥-–ª–æ–∞–¥–µ—Ä.

1. –ö–æ–Ω—Ñ–∏–≥-–ª–æ–∞–¥–µ—Ä
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/config_loader.py –Ω–∞ –±–∞–∑–µ pathlib + yaml.safe_load.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫—ç—à–∏—Ä—É–µ–º—ã–π load_system_config –∏ —Ö–µ–ª–ø–µ—Ä—ã get_environment, get_llm_mode, get_llm_connector_path.
- –ö–æ–Ω—Ñ–∏–≥ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ config/system.yaml, –≤–∞–ª–∏–¥–∞—Ü–∏—è environment (dev/test/prod).

2. API /api/v1/task/query
- –î–æ–±–∞–≤–ª–µ–Ω —Ä–æ—É—Ç–µ—Ä app/api/v1/routes.py —Å APIRouter(prefix="/api/v1").
- –û–ø–∏—Å–∞–Ω—ã –º–æ–¥–µ–ª–∏ TaskQueryRequest/TaskQueryResponse –Ω–∞ Pydantic v2 (pattern –¥–ª—è task_type).
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω POST /api/v1/task/query:
  - –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (task_type=corporate) –ø—Ä–∏ environment != prod;
  - –¥–ª—è demo-–∑–∞–¥–∞—á –≤ dev –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é LLM —á–µ—Ä–µ–∑ call_llm —Å –ø—Ä–æ—Å—Ç—ã–º —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º;
  - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON {ok, answer|error}.

3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI
- –í app/main.py –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–æ—É—Ç–µ—Ä api_v1_router.
- –≠–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/health –∏—Å–ø–æ–ª—å–∑—É–µ—Ç get_environment –∏ get_llm_mode –∏–∑ –∫–æ–Ω—Ñ–∏–≥-–ª–æ–∞–¥–µ—Ä–∞.
- –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Ä—É—á–∫–∏ —á–µ—Ä–µ–∑ curl:
  - /api/v1/health –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å ok –∏ environment=dev;
  - /api/v1/task/query —Å demo-–∑–∞–¥–∞—á–µ–π –æ—Ç–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏;
  - /api/v1/task/query —Å corporate-–∑–∞–¥–∞—á–µ–π –≤ dev –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ prod".


[2026-02-05 13:05] TaskConfig –∏ —Ñ–∞–π–ª–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –∑–∞–¥–∞—á.

1. –ú–æ–¥–µ–ª—å TaskConfig
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/task_config.py.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ dataclass-–º–æ–¥–µ–ª—å TaskConfig —Å –ø–æ–ª—è–º–∏ task_id, name, description, task_type, technical_prompt.
- –î–æ–±–∞–≤–ª–µ–Ω load_task_config(task_id), –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç config/tasks/<task_id>.yaml –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç task_type (demo/corporate).

2. –ö–æ–Ω—Ñ–∏–≥ –∑–∞–¥–∞—á–∏ demo_hello
- –°–æ–∑–¥–∞–Ω –∫–∞—Ç–∞–ª–æ–≥ config/tasks.
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª config/tasks/demo_hello.yaml —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º TaskConfig:
  - task_id=demo_hello, task_type=demo;
  - —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ name/description;
  - technical_prompt —Å –±–∏–∑–Ω–µ—Å-–æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–µ–º–æ-—Å–∏—Å—Ç–µ–º—ã –∑–∞—è–≤–æ–∫.

3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ /api/v1/task/query
- –≠–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/task/query –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TaskConfig:
  - –≥—Ä—É–∑–∏—Ç –∫–æ–Ω—Ñ–∏–≥ –ø–æ task_id —á–µ—Ä–µ–∑ load_task_config;
  - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ request.task_type –∏ TaskConfig.task_type;
  - –±–ª–æ–∫–∏—Ä—É–µ—Ç corporate-–∑–∞–¥–∞—á–∏ –ø—Ä–∏ environment != prod;
  - –¥–ª—è demo-–∑–∞–¥–∞—á –≤ dev –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é LLM —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–º–ø—Ç–æ–º –∏–∑ TaskConfig.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl —Å task_id=demo_hello –≤–µ—Ä–Ω—É–ª–∞ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å-–æ—Ç–≤–µ—Ç –æ –¥–µ–º–æ-—Å–∏—Å—Ç–µ–º–µ –∑–∞—è–≤–æ–∫.

[2026-02-05 14:38] –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π demo-RAG –Ω–∞ ChromaDB –∏ —Ñ–∏–∫—Å–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

1. ChromaDB –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –í .venv —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã chromadb –∏ sentence-transformers –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ RAG.
- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω —Ç–µ–∫—É—â–∏–π —Å—Ç–µ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π:
  pip list --format=freeze > requirements.txt
- requirements.txt —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è.

2. –ö–ª–∏–µ–Ω—Ç ChromaDB
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/chroma_client.py.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω get_chroma_client() —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º config/system.yaml (paths.chromadb_dir) –∏ persistent-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ ./data/chromadb.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ–¥ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

3. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π RAG-–ø–∞–π–ø–ª–∞–π–Ω
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/rag_pipeline.py.
- ensure_demo_hello_collection() –ª–µ–Ω–∏–≤–æ —Å–æ–∑–¥–∞—ë—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é demo_hello_texts –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –Ω–µ—ë –¥–µ–º–æ-–¥–æ–∫—É–º–µ–Ω—Ç –æ —Å–∏—Å—Ç–µ–º–µ –∑–∞—è–≤–æ–∫.
- retrieve_text_chunks(...) –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ top-k —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –ø–æ ChromaDB –¥–ª—è demo_hello.
- build_llm_prompt(...) –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç technical_prompt –∏–∑ TaskConfig –∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –µ–¥–∏–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM.

4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ /api/v1/task/query –ø–æ–¥ RAG
- –≠–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/task/query –¥–ª—è demo-–∑–∞–¥–∞—á —Ç–µ–ø–µ—Ä—å:
  - –≥—Ä—É–∑–∏—Ç TaskConfig –ø–æ task_id;
  - –¥–µ–ª–∞–µ—Ç retrieve_text_chunks(...) –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ build_llm_prompt(...);
  - –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é LLM —á–µ—Ä–µ–∑ call_llm —Å –ø–æ–¥–º–µ—à–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl —Å task_id=demo_hello –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –æ—Ç–≤–µ—Ç—ã –º–æ–¥–µ–ª–∏ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –∏–¥–µ—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã –∑–∞—è–≤–æ–∫, —Ç–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ ChromaDB —Ä–µ–∞–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ç–≤–µ—Ç.

[2026-02-05 14:44] TaskRegistry –∏ AccessControl –¥–ª—è –∑–∞–¥–∞—á.

1. –†–µ–µ—Å—Ç—Ä –∑–∞–¥–∞—á
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/task_registry.py.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω TaskRegistry —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º TaskConfig –ø–æ task_id –∏ –ø—Ä–æ—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º RegisteredTask.
- –í–≤–µ–¥—ë–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π singleton task_registry –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ API –∏ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π.

2. Access control –ø–æ –¢–ó
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/core/access_control.py.
- –§—É–Ω–∫—Ü–∏—è check_task_access(TaskConfig) —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞:
  - task_type=demo —Ä–∞–∑—Ä–µ—à—ë–Ω –≤ –ª—é–±—ã—Ö —Ä–µ–∂–∏–º–∞—Ö (dev/test/prod);
  - task_type=corporate —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –≤ prod, –≤ dev/test –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–∫–∞–∑.
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ AccessDecision –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ñ–ª–∞–≥ allowed –∏ reason.

3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ /api/v1/task/query
- –≠–Ω–¥–ø–æ–∏–Ω—Ç /api/v1/task/query –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ task_registry –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ load_task_config.
- –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ TaskConfig –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å request.task_type –∏ TaskConfig.task_type.
- –†–µ—à–µ–Ω–∏–µ –æ –¥–æ—Å—Ç—É–ø–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ –º–æ–¥—É–ª—é AccessControl; –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç 403 –∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ reason.
- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ demo-–∑–∞–¥–∞—á–∏ pipeline –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º: retrieve_text_chunks + build_llm_prompt + –≤—ã–∑–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ–π LLM.

4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ curl –∫ demo_hello –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ demo-–∑–∞–¥–∞—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Ä–µ–µ—Å—Ç—Ä–∞ –∑–∞–¥–∞—á –∏ access control.

[2026-02-05 15:03] –ê–¥–º–∏–Ω-CLI n3r7 –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á.

1. –ê–¥–º–∏–Ω-CLI
- –î–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å app/cli/admin_cli.py –Ω–∞ –±–∞–∑–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ click.
- –í CLI –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ env –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—É—â–µ–≥–æ environment (dev/test/prod) —á–µ—Ä–µ–∑ get_environment().
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ task-info <task_id>, –∫–æ—Ç–æ—Ä–∞—è:
  - –≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç TaskConfig —á–µ—Ä–µ–∑ task_registry.get_task_config;
  - –≤—ã–≤–æ–¥–∏—Ç task_id, name, description, task_type –ø–æ –∑–∞–¥–∞—á–µ.
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ tasks-loaded –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤ TaskRegistry –∑–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ CLI
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: python -m app.cli.admin_cli env ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç Environment: dev.
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: python -m app.cli.admin_cli task-info demo_hello ‚Üí –≤—ã–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ TaskConfig –¥–ª—è demo_hello.
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: python -m app.cli.admin_cli tasks-loaded ‚Üí –ø–æ–∫–∞ —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á –≤ —Ä–µ–µ—Å—Ç—Ä–µ –Ω–µ—Ç (—Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ –º–µ—Ä–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ API –∏ CLI).


[2026-02-05 15:05] –í—Ç–æ—Ä–∞—è demo-–∑–∞–¥–∞—á–∞ demo_rules –∏ –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω—ã–π RAG.

1. –ù–æ–≤—ã–π TaskConfig demo_rules
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª config/tasks/demo_rules.yaml.
- –û–ø–∏—Å–∞–Ω–∞ demo-–∑–∞–¥–∞—á–∞ "Demo: —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤–∏–ª–∞" —Å —Ç–∏–ø–æ–º task_type=demo.
- technical_prompt –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.

2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ RAG-–ø–∞–π–ø–ª–∞–π–Ω–∞
- –û–±–Ω–æ–≤–ª—ë–Ω app/core/rag_pipeline.py:
  - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ ensure_collection_for_task(task_cfg) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
    - demo_hello ‚Üí –∫–æ–ª–ª–µ–∫—Ü–∏—è demo_hello_texts;
    - demo_rules ‚Üí –∫–æ–ª–ª–µ–∫—Ü–∏—è demo_rules_texts.
  - –¥–ª—è demo_rules –¥–æ–±–∞–≤–ª–µ–Ω –¥–µ–º–æ-–¥–æ–∫—É–º–µ–Ω—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –±–∞–∑–æ–≤—ã—Ö —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤: –∑–∞—è–≤–∫–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø—ã, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.
- –§—É–Ω–∫—Ü–∏—è retrieve_text_chunks(...) —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–π demo-–∑–∞–¥–∞—á–µ–π —á–µ—Ä–µ–∑ ensure_collection_for_task.
- build_llm_prompt(...) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∂–µ —Å–æ –≤—Ç–æ—Ä—ã–º —Ç–∏–ø–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ demo_rules —á–µ—Ä–µ–∑ API
- –í—ã–ø–æ–ª–Ω–µ–Ω –∑–∞–ø—Ä–æ—Å:
  - task_id=demo_rules, task_type=demo;
  - –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ –∑–∞—è–≤–∫–∞–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
- –û—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π LLM —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç—Å—ã–ª–∫—É –∫ –∑–∞—è–≤–∫–∞–º, –¥–æ—Å—Ç—É–ø–∞–º –∫ —Å–∏—Å—Ç–µ–º–∞–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ demo_rules_texts.

4. –ü—Ä–æ–≤–µ—Ä–∫–∞ demo_rules —á–µ—Ä–µ–∑ CLI
- –ö–æ–º–∞–Ω–¥–∞ python -m app.cli.admin_cli task-info demo_rules –≤—ã–≤–æ–¥–∏—Ç TaskConfig –¥–ª—è demo_rules (task_id, name, description, task_type).

## FILE: README.md
# N3R7A2C7

**Version:** 0.3

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
N3R7A2C7/
‚îú‚îÄ‚îÄ README.md              # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ CHANGELOG.md           # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ PROJECT_PLAN.md        # –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îú‚îÄ‚îÄ logs/                  # –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ docs/                  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ src/                   # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
```

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π: Git/GitHub
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: Markdown
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## –°—Ç–∞—Ç—É—Å

üîß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - –≤–µ—Ä—Å–∏—è 0.3

---
*–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å–º. –≤ PROJECT_PLAN.md*

## FILE: app/api/v1/__init__.py


## FILE: app/api/v1/routes.py
from typing import Optional

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field

from app.core.task_registry import task_registry, TaskRegistryError
from app.core.access_control import check_task_access
from app.core.rag_pipeline import retrieve_text_chunks, build_llm_prompt
from llm_connectors.connector_dev import call_llm, LLMError


router = APIRouter(prefix="/api/v1", tags=["tasks"])


class TaskQueryRequest(BaseModel):
    task_id: str = Field(..., description="–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä demo_hello")
    task_type: str = Field(
        "demo",
        description="–¢–∏–ø –∑–∞–¥–∞—á–∏: demo –∏–ª–∏ corporate (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å TaskConfig)",
        pattern="^(demo|corporate)$",
    )
    query: str = Field(..., description="–¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞")


class TaskQueryResponse(BaseModel):
    ok: bool
    answer: Optional[str] = None
    error: Optional[str] = None


@router.post("/task/query", response_model=TaskQueryResponse)
async def task_query(request: TaskQueryRequest) -> TaskQueryResponse:
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ –¢–ó:
    - –ø–æ–ª—É—á–∞–µ—Ç TaskConfig —á–µ—Ä–µ–∑ TaskRegistry;
    - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å task_type;
    - –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ –¥–æ—Å—Ç—É–ø—É –º–æ–¥—É–ª—é AccessControl;
    - –¥–ª—è demo-–∑–∞–¥–∞—á –¥–µ–ª–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π RAG –ø–æ —Ç–µ–∫—Å—Ç–∞–º –∏ –≤—ã–∑—ã–≤–∞–µ—Ç LLM;
    - corporate-–∑–∞–¥–∞—á–∏ –≤ dev/test –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.
    """
    try:
        task_cfg = task_registry.get_task_config(request.task_id)
    except TaskRegistryError as e:
        raise HTTPException(status_code=404, detail=str(e))

    if task_cfg.task_type != request.task_type:
        raise HTTPException(
            status_code=400,
            detail=f"Request task_type={request.task_type} does not match TaskConfig.task_type={task_cfg.task_type}",
        )

    decision = check_task_access(task_cfg)
    if not decision.allowed:
        raise HTTPException(status_code=403, detail=decision.reason)

    if task_cfg.task_type == "demo":
        chunks = retrieve_text_chunks(task_cfg, request.query, top_k=3)
        system_prompt = build_llm_prompt(task_cfg, request.query, chunks)

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": request.query},
        ]
        try:
            resp = await call_llm(messages, model="llama3.2:1b")
            answer = resp["choices"][0]["message"]["content"]
            return TaskQueryResponse(ok=True, answer=answer)
        except LLMError as e:
            return TaskQueryResponse(ok=False, error=str(e))

    raise HTTPException(status_code=400, detail="Unsupported task_type")

## FILE: app/cli/admin_cli.py
import sys
from pathlib import Path
from typing import List

import click

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path, —á—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å app.*
PROJECT_ROOT = Path(__file__).parent.parent.parent.resolve()
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from app.core.task_registry import task_registry  # noqa: E402
from app.core.task_config import TaskConfigError  # noqa: E402
from app.core.config_loader import get_environment  # noqa: E402


@click.group()
def cli() -> None:
    """
    –ê–¥–º–∏–Ω-CLI –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º—ã (—Ä–µ–∂–∏–º n3r7).
    """
    pass


@cli.command("env")
def show_env() -> None:
    """
    –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π environment (dev/test/prod).
    """
    env = get_environment()
    click.echo(f"Environment: {env}")


@cli.command("task-info")
@click.argument("task_id", type=str)
def task_info(task_id: str) -> None:
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ –ø–æ task_id.
    """
    try:
        cfg = task_registry.get_task_config(task_id)
    except TaskConfigError as e:
        click.echo(f"Error: {e}")
        sys.exit(1)
    except Exception as e:
        click.echo(f"Registry error: {e}")
        sys.exit(1)

    click.echo(f"task_id     : {cfg.task_id}")
    click.echo(f"name        : {cfg.name}")
    click.echo(f"description : {cfg.description}")
    click.echo(f"task_type   : {cfg.task_type}")


@cli.command("tasks-loaded")
def tasks_loaded() -> None:
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏, —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ TaskRegistry –∑–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.
    """
    tasks = task_registry.list_registered_tasks()
    if not tasks:
        click.echo("No tasks loaded in registry yet.")
        return

    click.echo("Loaded tasks:")
    for t in tasks:
        click.echo(f"- {t.task_id} [{t.task_type}] ‚Äî {t.name}")


if __name__ == "__main__":
    cli()

## FILE: app/core/__init__.py


## FILE: app/core/access_control.py
from dataclasses import dataclass

from app.core.config_loader import get_environment
from app.core.task_config import TaskConfig


@dataclass
class AccessDecision:
    allowed: bool
    reason: str


def check_task_access(task_cfg: TaskConfig) -> AccessDecision:
    """
    –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –∏–∑ –¢–ó:
    - demo: –º–æ–∂–Ω–æ –≤ prod/dev/test;
    - corporate: —Ç–æ–ª—å–∫–æ –≤ prod, –≤ dev/test ‚Äî –±–ª–æ–∫.
    """
    env = get_environment()

    if task_cfg.task_type == "demo":
        return AccessDecision(
            allowed=True,
            reason=f"demo task in environment={env} is allowed",
        )

    if task_cfg.task_type == "corporate":
        if env == "prod":
            return AccessDecision(
                allowed=True,
                reason="corporate task in prod is allowed",
            )
        return AccessDecision(
            allowed=False,
            reason="corporate tasks are allowed only in prod",
        )

    return AccessDecision(
        allowed=False,
        reason=f"Unknown task_type={task_cfg.task_type}",
    )

## FILE: app/core/chroma_client.py
from pathlib import Path
from typing import Optional

import chromadb
from chromadb.api import ClientAPI
from chromadb.config import Settings

from app.core.config_loader import load_system_config, SystemConfigError


_chroma_client: Optional[ClientAPI] = None


def get_chroma_client() -> ClientAPI:
    global _chroma_client
    if _chroma_client is not None:
        return _chroma_client

    cfg = load_system_config()
    paths = cfg.get("paths", {}) or {}
    chroma_dir = paths.get("chromadb_dir", "./data/chromadb")
    chroma_path = Path(chroma_dir)
    chroma_path.mkdir(parents=True, exist_ok=True)

    _chroma_client = chromadb.Client(
        Settings(
            is_persistent=True,
            persist_directory=str(chroma_path),
        )
    )
    return _chroma_client

## FILE: app/core/config_loader.py
from pathlib import Path
from functools import lru_cache
from typing import Any, Dict

import yaml


class SystemConfigError(Exception):
    pass


@lru_cache(maxsize=1)
def load_system_config() -> Dict[str, Any]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç config/system.yaml –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∂–∏–∑–Ω—å –ø—Ä–æ—Ü–µ—Å—Å–∞.
    """
    config_path = Path(__file__).parent.parent.parent / "config" / "system.yaml"
    if not config_path.is_file():
        raise SystemConfigError(f"Config file not found: {config_path}")

    try:
        data = yaml.safe_load(config_path.read_text(encoding="utf-8"))
    except Exception as e:
        raise SystemConfigError(f"Failed to read system config: {e}") from e

    if not isinstance(data, dict):
        raise SystemConfigError("System config must be a mapping at top level")

    return data


def get_environment() -> str:
    cfg = load_system_config()
    env = cfg.get("environment", "dev")
    if env not in {"dev", "test", "prod"}:
        raise SystemConfigError(f"Invalid environment in config: {env}")
    return env


def get_llm_mode() -> str:
    cfg = load_system_config()
    llm = cfg.get("llm", {}) or {}
    mode = llm.get("mode", "dev")
    return mode


def get_llm_connector_path() -> str:
    cfg = load_system_config()
    llm = cfg.get("llm", {}) or {}
    connector = llm.get("connector")
    if not connector:
        raise SystemConfigError("llm.connector is not set in system config")
    return connector

## FILE: app/core/llm_client.py


## FILE: app/core/rag_pipeline.py
from dataclasses import dataclass
from typing import List

from app.core.task_config import TaskConfig
from app.core.chroma_client import get_chroma_client


@dataclass
class RetrievedChunk:
    text: str
    source_id: str
    score: float


def ensure_collection_for_task(task_cfg: TaskConfig):
    """
    –õ–µ–Ω–∏–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –¥–µ–º–æ-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö demo-–∑–∞–¥–∞—á.
    """
    client = get_chroma_client()

    if task_cfg.task_id == "demo_hello":
        coll = client.get_or_create_collection(name="demo_hello_texts")
        if coll.count() > 0:
            return coll

        demo_doc = (
            "–≠—Ç–æ –¥–µ–º–æ-–¥–æ–∫—É–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –∑–∞—è–≤–æ–∫. "
            "–°–∏—Å—Ç–µ–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞–º –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º, "
            "–∞ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –¥–æ—Å—Ç—É–ø–∞–º –∏ –ò–¢-—Å–µ—Ä–≤–∏—Å–∞–º. "
            "–í –±—É–¥—É—â–µ–º —Å—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç–æ—è—â–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."
        )

        coll.add(
            ids=["demo_hello_doc_1"],
            documents=[demo_doc],
            metadatas=[{"source_id": "demo_hello_doc_1", "kind": "demo"}],
        )
        return coll

    if task_cfg.task_id == "demo_rules":
        coll = client.get_or_create_collection(name="demo_rules_texts")
        if coll.count() > 0:
            return coll

        demo_doc = (
            "–í –∫–æ–º–ø–∞–Ω–∏–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç –±–∞–∑–æ–≤—ã–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã: "
            "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±—è–∑–∞–Ω —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø—ã –∫ —Å–∏—Å—Ç–µ–º–∞–º —á–µ—Ä–µ–∑ –∑–∞—è–≤–∫–∏, "
            "—Å–æ–±–ª—é–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "
            "—Ç–æ–ª—å–∫–æ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. "
            "–í—Å–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –æ–±—Å—É–∂–¥–∞—Ç—å—Å—è —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –∏–ª–∏ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏."
        )

        coll.add(
            ids=["demo_rules_doc_1"],
            documents=[demo_doc],
            metadatas=[{"source_id": "demo_rules_doc_1", "kind": "demo"}],
        )
        return coll

    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    return None


def retrieve_text_chunks(task_cfg: TaskConfig, query: str, top_k: int = 3) -> List[RetrievedChunk]:
    """
    –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç–∞–º –¥–ª—è demo-–∑–∞–¥–∞—á.
    """
    coll = ensure_collection_for_task(task_cfg)
    if coll is None:
        return []

    res = coll.query(query_texts=[query], n_results=top_k)

    docs = res.get("documents", [[]])[0]
    ids = res.get("ids", [[]])[0]
    dists = res.get("distances", [[]])[0]  # —á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –ª—É—á—à–µ

    chunks: List[RetrievedChunk] = []
    for doc, _id, dist in zip(docs, ids, dists):
        chunks.append(
            RetrievedChunk(
                text=doc,
                source_id=_id,
                score=float(dist),
            )
        )
    return chunks


def build_llm_prompt(task_cfg: TaskConfig, query: str, chunks: List[RetrievedChunk]) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç + –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    """
    base_prompt = task_cfg.technical_prompt or (
        "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RAG-—Å–∏—Å—Ç–µ–º—ã. –û—Ç–≤–µ—á–∞–π –ø–æ –¥–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç."
    )

    context_lines: List[str] = []
    for i, ch in enumerate(chunks, start=1):
        context_lines.append(f"[–§—Ä–∞–≥–º–µ–Ω—Ç {i}, source={ch.source_id}, score={ch.score:.4f}]\n{ch.text}")

    context_block = "\n\n".join(context_lines) if context_lines else "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω."

    full_prompt = (
        f"{base_prompt}\n\n"
        f"–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:\n"
        f"{context_block}\n\n"
        f"–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {query}\n\n"
        f"–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç. "
        f"–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º."
    )
    return full_prompt

## FILE: app/core/task_config.py
from dataclasses import dataclass
from pathlib import Path
from typing import Any, Dict

import yaml


class TaskConfigError(Exception):
    pass


@dataclass
class TaskConfig:
    task_id: str
    name: str
    description: str
    task_type: str  # "demo" | "corporate"
    technical_prompt: str

    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "TaskConfig":
        try:
            task_id = data["task_id"]
            name = data.get("name", task_id)
            description = data.get("description", "")
            task_type = data.get("task_type", "demo")
            technical_prompt = data.get("technical_prompt", "")
        except KeyError as e:
            raise TaskConfigError(f"Missing required field in TaskConfig: {e}") from e

        if task_type not in {"demo", "corporate"}:
            raise TaskConfigError(f"Invalid task_type in TaskConfig: {task_type}")

        return cls(
            task_id=task_id,
            name=name,
            description=description,
            task_type=task_type,
            technical_prompt=technical_prompt,
        )


def load_task_config(task_id: str) -> TaskConfig:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç config/tasks/<task_id>.yaml –∏ –ø–∞—Ä—Å–∏—Ç –≤ TaskConfig.
    –°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π –∏–∑ –¢–ó.
    """
    tasks_dir = Path(__file__).parent.parent.parent / "config" / "tasks"
    cfg_path = tasks_dir / f"{task_id}.yaml"

    if not cfg_path.is_file():
        raise TaskConfigError(f"Task config not found for task_id={task_id}: {cfg_path}")

    try:
        data = yaml.safe_load(cfg_path.read_text(encoding="utf-8"))
    except Exception as e:
        raise TaskConfigError(f"Failed to read TaskConfig YAML: {e}") from e

    if not isinstance(data, dict):
        raise TaskConfigError("TaskConfig YAML must be a mapping at top level")

    return TaskConfig.from_dict(data)

## FILE: app/core/task_registry.py
from dataclasses import dataclass
from typing import Dict, List

from app.core.task_config import TaskConfig, load_task_config, TaskConfigError


@dataclass
class RegisteredTask:
    task_id: str
    task_type: str  # "demo" | "corporate"
    name: str
    description: str


class TaskRegistryError(Exception):
    pass


class TaskRegistry:
    """
    –ü—Ä–æ—Å—Ç–æ–π —Ñ–∞–π–ª–æ–≤—ã–π —Ä–µ–µ—Å—Ç—Ä –∑–∞–¥–∞—á –ø–æ–≤–µ—Ä—Ö TaskConfig (config/tasks/*.yaml).
    –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –∫—ç—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–¥–∞—á–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º —Ä–µ–∞–ª—å–Ω–æ –æ–±—Ä–∞—â–∞–ª–∏—Å—å.
    """

    def __init__(self) -> None:
        self._tasks: Dict[str, TaskConfig] = {}

    def get_task_config(self, task_id: str) -> TaskConfig:
        if task_id in self._tasks:
            return self._tasks[task_id]
        try:
            cfg = load_task_config(task_id)
        except TaskConfigError as e:
            raise TaskRegistryError(str(e)) from e
        self._tasks[task_id] = cfg
        return cfg

    def list_registered_tasks(self) -> List[RegisteredTask]:
        """
        –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.
        –í –±—É–¥—É—â–µ–º —Å—é–¥–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ config/tasks/*.yaml.
        """
        result: List[RegisteredTask] = []
        for cfg in self._tasks.values():
            result.append(
                RegisteredTask(
                    task_id=cfg.task_id,
                    task_type=cfg.task_type,
                    name=cfg.name,
                    description=cfg.description,
                )
            )
        return result


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å —Ä–µ–µ—Å—Ç—Ä—ã
task_registry = TaskRegistry()

## FILE: app/main.py
from fastapi import FastAPI
from fastapi.responses import JSONResponse

from llm_connectors.connector_dev import call_llm, LLMError
from app.api.v1.routes import router as api_v1_router
from app.core.config_loader import get_environment, get_llm_mode


app = FastAPI(title="RAG Service", version="0.1.0")

app.include_router(api_v1_router)


@app.get("/api/v1/health")
async def health():
    env = get_environment()
    llm_mode = get_llm_mode()
    return JSONResponse(
        {
            "status": "ok",
            "environment": env,
            "chromadb": "unknown",
            "sqlite": "unknown",
            "llm_mode": llm_mode or "unknown",
            "uptime_seconds": 0,
        }
    )


@app.get("/api/v1/llm_test")
async def llm_test():
    try:
        resp = await call_llm(
            [{"role": "user", "content": "–°–∫–∞–∂–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: —Ç–µ—Å—Ç."}],
            model="llama3.2:1b",
        )
        content = resp["choices"][0]["message"]["content"]
        return {"ok": True, "answer": content}
    except LLMError as e:
        return {"ok": False, "error": str(e)}

## FILE: code_collector.py
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent.resolve()
SNAPSHOT_FILE = PROJECT_ROOT / "all_code.txt"

INCLUDE_EXTS = {".py", ".yaml", ".yml", ".txt", ".md"}
EXCLUDE_FILES = {"all_code.txt", ".env"}


def should_include(path: Path) -> bool:
    # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä—ã—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (–Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å ".")
    for part in path.parts:
        if part.startswith("."):
            return False
    if path.name in EXCLUDE_FILES:
        return False
    if path.suffix not in INCLUDE_EXTS:
        return False
    return True


def collect_files():
    files = []
    seen = set()
    for p in PROJECT_ROOT.rglob("*"):
        if not p.is_file():
            continue
        rel = p.relative_to(PROJECT_ROOT)
        if rel in seen:
            continue
        if should_include(p):
            seen.add(rel)
            files.append(p)
    return sorted(files, key=lambda p: str(p))


def build_snapshot():
    files = collect_files()
    lines = []
    lines.append("# SNAPSHOT OF PROJECT FILES (TEXT)\n")
    lines.append("# Each file is separated by a marker line: ## FILE: <relative_path>\n\n")

    for path in files:
        rel_path = path.relative_to(PROJECT_ROOT)
        lines.append(f"## FILE: {rel_path}\n")
        try:
            text = path.read_text(encoding="utf-8")
        except Exception as e:
            lines.append(f"# ERROR READING FILE: {e}\n\n")
            continue
        lines.append(text)
        if not text.endswith("\n"):
            lines.append("\n")
        lines.append("\n")

    SNAPSHOT_FILE.write_text("".join(lines), encoding="utf-8")
    print(f"[code_collector] Snapshot written to {SNAPSHOT_FILE} ({len(files)} files).")


def main():
    print("code_collector.py ‚Äî —Å–Ω–∏–º–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ –≤ all_code.txt")
    print("1) –û–±–Ω–æ–≤–∏—Ç—å all_code.txt (–≤—Å–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–∞–ø–æ–∫)")
    choice = input("–í—ã–±–æ—Ä (1): ").strip() or "1"
    if choice == "1":
        build_snapshot()
    else:
        print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—é.")


if __name__ == "__main__":
    main()

## FILE: config/system.yaml
environment: dev  # dev | test | prod

paths:
  data_root: "./data"
  chromadb_dir: "./data/chromadb"
  sqlite_path: "./data/sqlite/tables.db"
  logs_path: "./data/logs/app.log"

llm:
  mode: dev        # dev -> OpenRouter, prod/test –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–∑–∂–µ
  connector: "llm_connectors.connector_dev:call_llm"

## FILE: config/tasks/demo_hello.yaml
task_id: demo_hello
name: "Demo: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞"
description: "–ü—Ä–æ—Å—Ç–∞—è –¥–µ–º–æ-–∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ RAG-—Å–µ—Ä–≤–∏—Å–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å LLM."
task_type: demo

technical_prompt: |
  –¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã RAG, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞—è–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
  –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ –¥–µ–ª—É.
  –°–µ–π—á–∞—Å —É –Ω–∞—Å –¥–µ–º–æ-—Ä–µ–∂–∏–º: –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è—Å–Ω–∏,
  —á—Ç–æ —ç—Ç–æ –∑–∞ –¥–µ–º–æ-—Å–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫ –∏ —á—Ç–æ –æ–Ω–∞ –≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ –±—É–¥–µ—Ç —É–º–µ—Ç—å
  –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å–∞ (–±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π).

## FILE: config/tasks/demo_rules.yaml
task_id: demo_rules
name: "Demo: —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤–∏–ª–∞"
description: "–î–µ–º–æ-–∑–∞–¥–∞—á–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏."
task_type: demo

technical_prompt: |
  –¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç RAG-—Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è
  –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏.
  –û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç—ã–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º, –±–µ–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≥—Ä—É–∑–∞.
  –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏,
  –∫ –∫–æ–º—É –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∏–ª–∏ –∫–∞–∫ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.

## FILE: docker/docker-compose.dev.yml


## FILE: llm_connectors/connector_dev.py
import os
from typing import List, Dict, Any

import httpx


OLLAMA_CHAT_URL = os.getenv(
    "OLLAMA_CHAT_URL",
    "http://127.0.0.1:4004/api/chat",
)


class LLMError(Exception):
    pass


async def call_llm(
    messages: List[Dict[str, Any]],
    model: str | None = None,
) -> Dict[str, Any]:
    """
    –î–µ–≤-–∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É ollama_chat_4b.
    messages: —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI (role/content).
    model: "llama3.2:1b" –∏–ª–∏ "llama3.2:3b" (–µ—Å–ª–∏ None ‚Äî –¥–µ—Ñ–æ–ª—Ç –≤ —Å–µ—Ä–≤–∏—Å–µ).
    """
    payload: Dict[str, Any] = {"messages": messages}
    if model:
        payload["model"] = model

    async with httpx.AsyncClient(timeout=120.0) as client:
        r = await client.post(OLLAMA_CHAT_URL, json=payload)
        if r.status_code != 200:
            raise LLMError(f"ollama_chat_4b error {r.status_code}: {r.text}")
        data = r.json()
        # –æ–∂–∏–¥–∞–µ–º {"reply": "...", "raw": {...}}
        reply = data.get("reply", "")
        return {
            "model": model or "default",
            "choices": [
                {"message": {"role": "assistant", "content": reply}}
            ],
            "raw": data.get("raw"),
        }

## FILE: requirements.txt
annotated-doc==0.0.4
annotated-types==0.7.0
anyio==4.12.1
attrs==25.4.0
backoff==2.2.1
bcrypt==5.0.0
build==1.4.0
certifi==2026.1.4
charset-normalizer==3.4.4
chromadb==1.4.1
click==8.3.1
coloredlogs==15.0.1
cuda-bindings==12.9.4
cuda-pathfinder==1.3.3
distro==1.9.0
dnspython==2.8.0
durationpy==0.10
email-validator==2.3.0
fastapi==0.128.1
fastapi-cli==0.0.20
fastapi-cloud-cli==0.11.0
fastar==0.8.0
filelock==3.20.3
flatbuffers==25.12.19
fsspec==2026.1.0
googleapis-common-protos==1.72.0
grpcio==1.76.0
h11==0.16.0
hf-xet==1.2.0
httpcore==1.0.9
httptools==0.7.1
httpx==0.28.1
huggingface_hub==1.4.0
humanfriendly==10.0
idna==3.11
importlib_metadata==8.7.1
importlib_resources==6.5.2
Jinja2==3.1.6
joblib==1.5.3
jsonschema==4.26.0
jsonschema-specifications==2025.9.1
kubernetes==35.0.0
markdown-it-py==4.0.0
MarkupSafe==3.0.3
mdurl==0.1.2
mmh3==5.2.0
mpmath==1.3.0
networkx==3.6.1
numpy==2.4.2
nvidia-cublas-cu12==12.8.4.1
nvidia-cuda-cupti-cu12==12.8.90
nvidia-cuda-nvrtc-cu12==12.8.93
nvidia-cuda-runtime-cu12==12.8.90
nvidia-cudnn-cu12==9.10.2.21
nvidia-cufft-cu12==11.3.3.83
nvidia-cufile-cu12==1.13.1.3
nvidia-curand-cu12==10.3.9.90
nvidia-cusolver-cu12==11.7.3.90
nvidia-cusparse-cu12==12.5.8.93
nvidia-cusparselt-cu12==0.7.1
nvidia-nccl-cu12==2.27.5
nvidia-nvjitlink-cu12==12.8.93
nvidia-nvshmem-cu12==3.4.5
nvidia-nvtx-cu12==12.8.90
oauthlib==3.3.1
onnxruntime==1.23.2
opentelemetry-api==1.39.1
opentelemetry-exporter-otlp-proto-common==1.39.1
opentelemetry-exporter-otlp-proto-grpc==1.39.1
opentelemetry-proto==1.39.1
opentelemetry-sdk==1.39.1
opentelemetry-semantic-conventions==0.60b1
orjson==3.11.7
overrides==7.7.0
packaging==26.0
pip==24.0
posthog==5.4.0
protobuf==6.33.5
pybase64==1.4.3
pydantic==2.12.5
pydantic_core==2.41.5
pydantic-extra-types==2.11.0
pydantic-settings==2.12.0
Pygments==2.19.2
PyPika==0.51.1
pyproject_hooks==1.2.0
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
python-multipart==0.0.22
PyYAML==6.0.3
referencing==0.37.0
regex==2026.1.15
requests==2.32.5
requests-oauthlib==2.0.0
rich==14.3.2
rich-toolkit==0.18.1
rignore==0.7.6
rpds-py==0.30.0
safetensors==0.7.0
scikit-learn==1.8.0
scipy==1.17.0
sentence-transformers==5.2.2
sentry-sdk==2.52.0
setuptools==80.10.2
shellingham==1.5.4
six==1.17.0
starlette==0.50.0
sympy==1.14.0
tenacity==9.1.3
threadpoolctl==3.6.0
tokenizers==0.22.2
torch==2.10.0
tqdm==4.67.3
transformers==5.0.0
triton==3.6.0
typer==0.21.1
typer-slim==0.21.1
typing_extensions==4.15.0
typing-inspection==0.4.2
urllib3==2.6.3
uvicorn==0.40.0
uvloop==0.22.1
watchfiles==1.1.1
websocket-client==1.9.0
websockets==16.0
zipp==3.23.0

## FILE: tests/test_api.py


